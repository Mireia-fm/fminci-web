"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { registrarCambioEstado } from "@/lib/historialEstados";

// Paleta de colores consistente
const PALETA = {
  fondo: "#5D6D52",
  headerTable: "#D9B6A9",
  card: "#F9FAF8",
  filtros: "#E8B5A8",
  texto: "#EDF0E9",
  textoOscuro: "#4b4b4b",
  verdeClaro: "#A9B88C", // Verde claro del dashboard para incidencias cerradas
  verdeSombra: "#7A8A6F", // Verde más claro que el fondo para sombra
};

type Adjunto = {
  id: string;
  tipo: string;
  nombre_archivo?: string | null;
  storage_key?: string | null;
};

type Comentario = {
  id: string;
  incidencia_id: string;
  ambito: 'cliente' | 'proveedor' | 'ambos';
  proveedor_id?: string | null;
  autor_id?: string | null;
  autor_email?: string | null;
  autor_rol?: string | null;
  cuerpo?: string | null;
  creado_en: string;
  es_sistema?: boolean | null;
  dedupe_key?: string | null;
  adjuntos?: Adjunto[];
};

type Incidencia = {
  id: string;
  num_solicitud: string;
  descripcion: string;
  estado_cliente: string;
  estado_proveedor?: string;
  prioridad_proveedor?: string;
  descripcion_proveedor?: string;
  centro?: string;
  fecha?: string;
  hora?: string;
  imagen_url?: string;
  catalogacion?: string;
  instituciones?: {
    nombre: string;
  }[] | null;
  adjuntos_principales?: Adjunto[];
};

export default function ChatProveedor() {
  const params = useParams();
  const router = useRouter();
  const [incidencia, setIncidencia] = useState<Incidencia | null>(null);
  const [comentarios, setComentarios] = useState<Comentario[]>([]);
  const [nuevoComentario, setNuevoComentario] = useState("");
  const [imagenSeleccionada, setImagenSeleccionada] = useState<File | null>(null);
  const [documentoSeleccionado, setDocumentoSeleccionado] = useState<File | null>(null);
  const [loading, setLoading] = useState(true);
  const [enviando, setEnviando] = useState(false);
  const [tipoUsuario, setTipoUsuario] = useState<string | null>(null);
  const [nombreUsuario, setNombreUsuario] = useState<string>("");
  const [autorId, setAutorId] = useState<string | null>(null);
  const [imageUrls, setImageUrls] = useState<Record<string, string>>({});
  const [commentAttachmentUrls, setCommentAttachmentUrls] = useState<Record<string, string>>({});
  const [mostrarModalVisita, setMostrarModalVisita] = useState(false);
  const [fechaVisita, setFechaVisita] = useState('');
  const [horarioVisita, setHorarioVisita] = useState('');
  const [mostrarModalPresupuesto, setMostrarModalPresupuesto] = useState(false);
  const [presupuesto, setPresupuesto] = useState('');
  const [descripcionPresupuesto, setDescripcionPresupuesto] = useState('');
  const [fechaEstimadaInicio, setFechaEstimadaInicio] = useState('');
  const [duracionEstimada, setDuracionEstimada] = useState('');
  const [importeTotalSinIva, setImporteTotalSinIva] = useState('');
  const [documentoPresupuesto, setDocumentoPresupuesto] = useState<File | null>(null);
  const [mostrarModalResolver, setMostrarModalResolver] = useState(false);
  const [solucionAplicada, setSolucionAplicada] = useState('');
  const [tieneOfertaAprobada, setTieneOfertaAprobada] = useState(false);
  const [importeResolucion, setImporteResolucion] = useState('');
  const [imagenResolucion, setImagenResolucion] = useState<File | null>(null);
  const [documentoResolucion, setDocumentoResolucion] = useState<File | null>(null);
  const [notasResolucion, setNotasResolucion] = useState('');
  const [mostrarModalValorar, setMostrarModalValorar] = useState(false);
  const [valoracion, setValoracion] = useState('');
  const [comentariosValoracion, setComentariosValoracion] = useState('');
  const [proveedorAsignado, setProveedorAsignado] = useState(false);
  const [visitaCalendarizada, setVisitaCalendarizada] = useState<{
    fecha: string;
    horario: string;
  } | null>(null);

  // Estados para modales de Control
  const [mostrarModalAnular, setMostrarModalAnular] = useState(false);
  const [mostrarModalCerrar, setMostrarModalCerrar] = useState(false);
  const [mostrarModalPendienteValoracion, setMostrarModalPendienteValoracion] = useState(false);
  const [motivoAnulacion, setMotivoAnulacion] = useState('');
  const [motivoCierre, setMotivoCierre] = useState('');
  const [presupuestoActual, setPresupuestoActual] = useState<any>(null);
  const [cargandoPresupuesto, setCargandoPresupuesto] = useState(false);
  const [nombreProveedor, setNombreProveedor] = useState<string | null>(null);

  const incidenciaId = params.id as string;

  useEffect(() => {
    cargarDatos();
  }, [incidenciaId]);

  // Cargar URLs de imágenes cuando cambie la incidencia
  useEffect(() => {
    if (incidencia?.adjuntos_principales) {
      const loadImageUrls = async () => {
        const urls: Record<string, string> = {};
        for (const adjunto of incidencia.adjuntos_principales || []) {
          if (adjunto.storage_key) {
            const url = await getSignedImageUrl(adjunto.storage_key);
            if (url) {
              urls[adjunto.id] = url;
            }
          }
        }
        setImageUrls(urls);
      };
      loadImageUrls();
    }
  }, [incidencia?.adjuntos_principales]);

  // Cargar URLs de adjuntos de comentarios
  useEffect(() => {
    if (comentarios.length > 0) {
      const loadCommentAttachmentUrls = async () => {
        const urls: Record<string, string> = {};
        for (const comentario of comentarios) {
          if (comentario.adjuntos) {
            for (const adjunto of comentario.adjuntos) {
              if (adjunto.storage_key) {
                const url = await getSignedImageUrl(adjunto.storage_key);
                if (url) {
                  urls[adjunto.id] = url;
                }
              }
            }
          }
        }
        setCommentAttachmentUrls(urls);
      };
      loadCommentAttachmentUrls();
    }
  }, [comentarios]);

  const cargarDatos = async () => {
    try {
      // Obtener datos del usuario actual
      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      if (!userEmail) {
        router.push('/login');
        return;
      }

      // Obtener información del usuario
      const { data: persona } = await supabase
        .from("personas")
        .select("id, rol, nombre")
        .eq("email", userEmail)
        .maybeSingle();

      if (persona) {
        setTipoUsuario(persona.rol);
        setNombreUsuario(persona.nombre || userEmail);
        setAutorId(persona.id);
      }

      // Obtener institución del proveedor (solo si es necesario)
      let personaInst = null;
      if (persona?.rol === 'Proveedor') {
        const { data: instData } = await supabase
          .from("personas_instituciones")
          .select("institucion_id")
          .eq("persona_id", persona.id)
          .maybeSingle();

        personaInst = instData;

        if (!personaInst?.institucion_id) {
          console.error("No se encontró institución para el proveedor");
          setLoading(false);
          return;
        }
      }

      // Cargar incidencia con adjuntos principales
      const { data: incidenciaData, error: incidenciaError } = await supabase
        .from("incidencias")
        .select(`
          id,
          num_solicitud,
          descripcion,
          estado_cliente,
          centro,
          fecha,
          hora,
          imagen_url,
          catalogacion,
          instituciones(nombre)
        `)
        .eq("id", incidenciaId)
        .single();

      // Verificar si la incidencia está asignada a un proveedor
      let estadoProveedor = null;
      let prioridadProveedor = null;
      let descripcionProveedor = null;
      let asignado = false;

      if (incidenciaData) {
        // Para usuarios de Control, verificar si existe alguna asignación activa
        if (persona?.rol === 'Control') {
          const { data: proveedorCaso } = await supabase
            .from("proveedor_casos")
            .select("estado_proveedor, proveedor_id, prioridad, descripcion_proveedor")
            .eq("incidencia_id", incidenciaId)
            .eq("activo", true)
            .maybeSingle();

          if (proveedorCaso) {
            estadoProveedor = proveedorCaso.estado_proveedor;
            prioridadProveedor = proveedorCaso.prioridad;
            descripcionProveedor = proveedorCaso.descripcion_proveedor;
            asignado = true;

            // Obtener el nombre del proveedor
            if (proveedorCaso.proveedor_id) {
              const { data: institacion } = await supabase
                .from("instituciones")
                .select("nombre")
                .eq("id", proveedorCaso.proveedor_id)
                .maybeSingle();

              if (institacion?.nombre) {
                setNombreProveedor(institacion.nombre);
              }
            }
          }
        }
        // Para proveedores, verificar si están asignados a esta incidencia
        else if (personaInst?.institucion_id) {
          const { data: proveedorCaso } = await supabase
            .from("proveedor_casos")
            .select("estado_proveedor, prioridad, descripcion_proveedor")
            .eq("incidencia_id", incidenciaId)
            .eq("proveedor_id", personaInst.institucion_id)
            .eq("activo", true)
            .maybeSingle();

          if (proveedorCaso) {
            estadoProveedor = proveedorCaso.estado_proveedor;
            prioridadProveedor = proveedorCaso.prioridad;
            descripcionProveedor = proveedorCaso.descripcion_proveedor;
            asignado = true;
          }
        }
      }

      setProveedorAsignado(asignado);

      // Cargar adjuntos principales (imágenes de la incidencia)
      let adjuntosPrincipales = [];
      if (incidenciaData) {
        const { data: adjuntosData } = await supabase
          .from("adjuntos")
          .select("*")
          .eq("incidencia_id", incidenciaId)
          .eq("categoria", "imagen_principal");

        adjuntosPrincipales = adjuntosData || [];

        // También considerar imagen_url de la incidencia si existe
        if (incidenciaData.imagen_url && adjuntosPrincipales.length === 0) {
          // Crear un adjunto virtual para imagen_url
          adjuntosPrincipales = [{
            id: 'imagen_url_' + incidenciaId,
            tipo: 'imagen',
            nombre_archivo: 'Imagen de la incidencia',
            storage_key: incidenciaData.imagen_url,
            categoria: 'imagen_principal'
          }];
        }
      }

      if (incidenciaError) {
        console.error("Error cargando incidencia:", incidenciaError);
      } else {
        setIncidencia({
          ...incidenciaData,
          estado_proveedor: estadoProveedor,
          prioridad_proveedor: prioridadProveedor,
          descripcion_proveedor: descripcionProveedor,
          adjuntos_principales: adjuntosPrincipales
        });
      }

      // Verificar si existe oferta aprobada para esta incidencia
      const { data: ofertaData } = await supabase
        .from("presupuestos")
        .select("estado")
        .eq("incidencia_id", incidenciaId)
        .eq("estado", "aprobado")
        .maybeSingle();

      setTieneOfertaAprobada(!!ofertaData);

      // Cargar comentarios del chat proveedor con adjuntos de comentarios
      const { data: comentariosData, error: comentariosError } = await supabase
        .from("comentarios")
        .select(`
          *,
          adjuntos(id, tipo, nombre_archivo, storage_key, categoria)
        `)
        .eq("incidencia_id", incidenciaId)
        .in("ambito", ["proveedor", "ambos"])
        .not("cuerpo", "is", null)
        .order("creado_en", { ascending: true });

      if (comentariosError) {
        console.error("Error cargando comentarios:", comentariosError);
      } else {
        setComentarios(comentariosData || []);
      }


    } catch (error) {
      console.error("Error:", error);
    } finally {
      setLoading(false);
    }
  };

  const enviarComentario = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!nuevoComentario.trim() || enviando || !tipoUsuario) return;

    try {
      setEnviando(true);

      const now = new Date();
      const fecha = now.toISOString().split('T')[0];
      const hora = now.toTimeString().split(' ')[0].slice(0, 5);

      // Subir archivos si existen
      let imagenUrl = null;
      let documentoUrl = null;

      if (imagenSeleccionada) {
        imagenUrl = await subirArchivo(imagenSeleccionada, 'imagenes');
      }

      if (documentoSeleccionado) {
        documentoUrl = await subirArchivo(documentoSeleccionado, 'documentos');
      }

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // Crear el comentario primero
      const { data: comentarioData, error } = await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'proveedor',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: tipoUsuario,
          cuerpo: nuevoComentario.trim(),
        })
        .select()
        .single();

      if (error) {
        console.error("Error enviando comentario:", error);
        return;
      }

      // Guardar archivos adjuntos si existen
      const adjuntos = [];
      
      if (imagenUrl && comentarioData) {
        adjuntos.push({
          incidencia_id: incidenciaId,
          comentario_id: comentarioData.id,
          tipo: 'imagen',
          categoria: 'imagen_comentario',
          nombre_archivo: imagenSeleccionada?.name,
          storage_key: imagenUrl
        });
      }

      if (documentoUrl && comentarioData) {
        adjuntos.push({
          incidencia_id: incidenciaId,
          comentario_id: comentarioData.id,
          tipo: 'documento',
          categoria: 'documento_comentario',
          nombre_archivo: documentoSeleccionado?.name,
          storage_key: documentoUrl
        });
      }

      if (adjuntos.length > 0) {
        const { error: adjuntosError } = await supabase
          .from("adjuntos")
          .insert(adjuntos);

        if (adjuntosError) {
          console.error("Error guardando adjuntos:", adjuntosError);
        }
      }

      setNuevoComentario("");
      setImagenSeleccionada(null);
      setDocumentoSeleccionado(null);
      cargarDatos(); // Recargar comentarios
    } catch (error) {
      console.error("Error:", error);
    } finally {
      setEnviando(false);
    }
  };

  const subirArchivo = async (archivo: File, tipo: 'imagenes' | 'documentos') => {
    try {
      const nombreArchivo = `${Date.now()}_${archivo.name}`;
      const ruta = `incidencias/${incidenciaId}/${tipo}/${nombreArchivo}`;
      
      console.log('Uploading file with path:', ruta);
      console.log('File details:', { name: archivo.name, size: archivo.size, type: archivo.type });
      
      const { data, error } = await supabase.storage
        .from('incidencias')
        .upload(ruta, archivo);
      
      if (error) {
        console.error('Upload error:', error);
        throw error;
      }
      
      console.log('Upload successful, data:', data);
      
      // Instead of public URL, return the storage path for consistency
      console.log('Returning storage path instead of public URL:', ruta);
      return ruta;
    } catch (error) {
      console.error('Error subiendo archivo:', error);
      return null;
    }
  };

  const manejarSeleccionImagen = (e: React.ChangeEvent<HTMLInputElement>) => {
    const archivo = e.target.files?.[0];
    if (archivo) {
      setImagenSeleccionada(archivo);
    }
  };

  const manejarSeleccionDocumento = (e: React.ChangeEvent<HTMLInputElement>) => {
    const archivo = e.target.files?.[0];
    if (archivo) {
      setDocumentoSeleccionado(archivo);
    }
  };

  const getColorEmisor = (emisor: string) => {
    switch (emisor.toLowerCase()) {
      case 'proveedor':
        return "#C9A96E";
      case 'control':
        return "#A9B88C";
      default:
        return PALETA.headerTable;
    }
  };

  const getSignedImageUrl = async (storageKey: string | null | undefined) => {
    if (!storageKey) return null;

    try {
      let cleanPath = storageKey;
      
      // Extract potential filename from storage_key
      let filename = '';
      if (storageKey.includes('/')) {
        const parts = storageKey.split('/');
        filename = parts[parts.length - 1]; // Get the last part (filename)
      } else {
        filename = storageKey;
      }
      
      console.log('Original storage_key:', storageKey);
      console.log('Extracted filename:', filename);
      
      // Extract storage path from full URLs
      if (storageKey.startsWith('https://')) {
        // Handle double prefix URLs (comment attachments)
        if (storageKey.includes('/storage/v1/object/public/incidencias/incidencias/')) {
          const parts = storageKey.split('/storage/v1/object/public/incidencias/incidencias/');
          if (parts.length > 1) {
            cleanPath = parts[1];
            console.log('Extracted path from double prefix URL:', cleanPath);
          }
        } 
        // Handle single prefix URLs
        else if (storageKey.includes('/storage/v1/object/public/incidencias/')) {
          const parts = storageKey.split('/storage/v1/object/public/incidencias/');
          if (parts.length > 1) {
            cleanPath = parts[1];
            console.log('Extracted path from single prefix URL:', cleanPath);
          }
        }
      }
      // For relative paths like "incidencias/00171/legacy/00171.jpg", use as-is
      else {
        console.log('Using relative path as-is:', cleanPath);
      }
      
      console.log('Attempting to create signed URL for path:', cleanPath);
      
      // Create signed URL for private access (expires in 4 hours)
      const { data, error } = await supabase.storage
        .from('incidencias')
        .createSignedUrl(cleanPath, 14400);
      
      if (error) {
        console.error('Error creating signed URL for path:', cleanPath, error);
        
        // If direct path fails, try to find the file by listing bucket contents
        console.log('Direct path failed, searching for file:', filename);
        
        try {
          const { data: files, error: listError } = await supabase.storage
            .from('incidencias')
            .list('');
            
          if (listError) {
            console.error('Error listing files:', listError);
            return null;
          }
          
          // Look for files with matching filename
          const matchingFile = files?.find(file => file.name === filename);
          
          if (matchingFile) {
            console.log('Found matching file:', matchingFile);
            // Try to create signed URL with the actual path
            const actualPath = matchingFile.name;
            const { data: signedData, error: signedError } = await supabase.storage
              .from('incidencias')
              .createSignedUrl(actualPath, 14400);
              
            if (!signedError && signedData) {
              console.log('Successfully created signed URL with actual path');
              return signedData.signedUrl;
            }
          }
          
          console.log('File not found in bucket listing');
        } catch (listingError) {
          console.error('Error during file search:', listingError);
        }
        
        return null;
      }
      
      console.log('Successfully created signed URL');
      return data.signedUrl;
    } catch (error) {
      console.error('Error generating signed URL:', error);
      return null;
    }
  };

  const calendarizarVisita = async () => {
    if (!fechaVisita || !horarioVisita || !autorId) {
      alert('Por favor, complete todos los campos obligatorios (fecha y horario)');
      return;
    }

    try {
      setEnviando(true);

      // Obtener datos del usuario actual
      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Obtener estado anterior y cambiar estado_proveedor a "En resolución"
      const { data: casoActual } = await supabase
        .from("proveedor_casos")
        .select("estado_proveedor")
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true)
        .single();

      const estadoAnterior = casoActual?.estado_proveedor || null;

      const { data: estadoActualizado, error: estadoError } = await supabase
        .from("proveedor_casos")
        .update({
          estado_proveedor: "En resolución"
        })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      if (estadoError) {
        console.error("Error actualizando estado del proveedor:", estadoError);
        throw estadoError;
      }

      // Registrar cambio de estado en el historial
      await registrarCambioEstado({
        incidenciaId,
        tipoEstado: 'proveedor',
        estadoAnterior,
        estadoNuevo: 'En resolución',
        autorId,
        motivo: 'Visita calendarizada',
        metadatos: {
          fecha_visita: fechaVisita,
          horario: horarioVisita,
          accion: 'calendarizar_visita'
        }
      });

      console.log("Estado actualizado a 'En resolución':", estadoActualizado);

      // 2. Crear timestamp para la visita y guardar en tabla de citas
      const horaVisita = horarioVisita === 'mañana' ? '09:00:00' : '14:00:00';
      const fechaHoraVisita = `${fechaVisita}T${horaVisita}`;

      // Obtener proveedor_id del caso actual
      const { data: proveedorCaso } = await supabase
        .from("proveedor_casos")
        .select("proveedor_id")
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true)
        .single();

      if (proveedorCaso?.proveedor_id) {
        const { data: citaCreada, error: citaError } = await supabase
          .from("citas_proveedores")
          .insert({
            incidencia_id: incidenciaId,
            proveedor_id: proveedorCaso.proveedor_id,
            fecha_visita: fechaHoraVisita,
            horario: horarioVisita,
            estado: 'programada',
            creado_por: autorId
          });

        if (citaError) {
          console.error("Error creando cita:", citaError);
          throw citaError;
        }

        console.log("Cita creada exitosamente:", citaCreada);
      }

      // 3. Formatear fecha para los comentarios
      const fechaFormateada = new Date(fechaVisita).toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      const horarioTexto = horarioVisita === 'mañana'
        ? 'horario de mañana'
        : 'horario de tarde';

      // 4. Agregar comentario visible en ambos chats
      const mensajeVisita = `Visita programada para el ${fechaFormateada} en ${horarioTexto}. El estado ha cambiado a "En resolución".`;

      // Comentario con ámbito 'ambos' - se verá en ambos chats
      const { error: errorComentario } = await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          autor_id: autorId,
          cuerpo: mensajeVisita,
          ambito: 'ambos',
          es_sistema: true
        });

      if (errorComentario) {
        console.error("Error insertando comentario:", errorComentario);
      } else {
        console.log("Comentario insertado exitosamente en ambos chats");
      }

      // 5. Mostrar pantalla de éxito
      setVisitaCalendarizada({
        fecha: fechaFormateada,
        horario: horarioTexto
      });

      // 6. Cerrar modal y recargar datos
      setMostrarModalVisita(false);
      setFechaVisita('');
      setHorarioVisita('');
      cargarDatos();

    } catch (error) {
      console.error("Error calendarizando visita:", error);
    } finally {
      setEnviando(false);
    }
  };

  const ofertarPresupuesto = async () => {
    if (!fechaEstimadaInicio || !duracionEstimada || !importeTotalSinIva || !documentoPresupuesto || !descripcionPresupuesto || !autorId) {
      alert('Por favor, complete todos los campos obligatorios');
      return;
    }

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Subir documento del presupuesto
      let documentoUrl = '';
      if (documentoPresupuesto) {
        const nombreArchivo = `${Date.now()}_${documentoPresupuesto.name}`;
        const ruta = `presupuestos/${incidenciaId}/${nombreArchivo}`;

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('incidencias')
          .upload(ruta, documentoPresupuesto);

        if (uploadError) {
          console.error('Error subiendo documento:', uploadError);
          throw uploadError;
        }

        documentoUrl = ruta;
      }

      // 2. Obtener proveedor_id del caso actual
      const { data: proveedorCaso } = await supabase
        .from("proveedor_casos")
        .select("proveedor_id, estado_proveedor")
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true)
        .single();

      if (!proveedorCaso) {
        throw new Error('No se encontró el caso del proveedor');
      }

      const estadoAnterior = proveedorCaso.estado_proveedor || null;

      // 3. Guardar presupuesto en la tabla presupuestos
      const { data: presupuestoCreado, error: presupuestoError } = await supabase
        .from("presupuestos")
        .insert({
          incidencia_id: incidenciaId,
          proveedor_id: proveedorCaso.proveedor_id,
          numero_incidencia: incidencia?.num_solicitud || '',
          fecha_estimada_inicio: fechaEstimadaInicio,
          duracion_estimada: duracionEstimada,
          importe_total_sin_iva: parseFloat(importeTotalSinIva),
          presupuesto_detallado_url: documentoUrl,
          descripcion_breve: descripcionPresupuesto,
          estado: 'pendiente_revision',
          creado_por: autorId
        });

      if (presupuestoError) {
        console.error("Error creando presupuesto:", presupuestoError);
        throw presupuestoError;
      }

      // 4. Cambiar estado_proveedor a "Ofertada"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Ofertada" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 5. Registrar cambio de estado en el historial
      await registrarCambioEstado({
        incidenciaId,
        tipoEstado: 'proveedor',
        estadoAnterior,
        estadoNuevo: 'Ofertada',
        autorId,
        motivo: 'Presupuesto detallado ofertado',
        metadatos: {
          presupuesto_id: presupuestoCreado?.[0]?.id,
          importe_total_sin_iva: parseFloat(importeTotalSinIva),
          fecha_estimada_inicio: fechaEstimadaInicio,
          duracion_estimada: duracionEstimada,
          accion: 'ofertar_presupuesto_detallado'
        }
      });

      // 6. Comentario en chat de proveedor con formato lista
      const mensajePresupuesto = `Datos del presupuesto:
• Fecha estimada de inicio: ${new Date(fechaEstimadaInicio).toLocaleDateString('es-ES')}
• Duración estimada: ${duracionEstimada}
• Importe total sin IVA: ${importeTotalSinIva}€
• Descripción: ${descripcionPresupuesto}

Documento adjunto: ${documentoPresupuesto.name}`;

      const { data: comentarioCreado, error: comentarioError } = await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'proveedor',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: 'Proveedor',
          cuerpo: mensajePresupuesto,
          es_sistema: false
        })
        .select()
        .single();

      if (comentarioError) {
        console.error("Error creando comentario:", comentarioError);
        throw comentarioError;
      }

      // 7. Agregar el documento como adjunto al comentario
      if (comentarioCreado && documentoUrl) {
        const { error: adjuntoError } = await supabase
          .from("adjuntos")
          .insert({
            incidencia_id: incidenciaId,
            comentario_id: comentarioCreado.id,
            tipo: 'documento',
            nombre_archivo: documentoPresupuesto.name,
            storage_key: documentoUrl,
            categoria: 'presupuesto'
          });

        if (adjuntoError) {
          console.error("Error agregando adjunto:", adjuntoError);
        }
      }

      // 8. Limpiar formulario y cerrar modal
      setMostrarModalPresupuesto(false);
      setFechaEstimadaInicio('');
      setDuracionEstimada('');
      setImporteTotalSinIva('');
      setDocumentoPresupuesto(null);
      setDescripcionPresupuesto('');
      cargarDatos();

    } catch (error) {
      console.error("Error ofertando presupuesto:", error);
      alert('Error al enviar el presupuesto. Por favor, inténtelo de nuevo.');
    } finally {
      setEnviando(false);
    }
  };

  const resolverIncidencia = async () => {
    // Validación condicional
    const camposObligatorios = [solucionAplicada, autorId];
    if (!tieneOfertaAprobada) {
      camposObligatorios.push(importeResolucion);
    }

    if (camposObligatorios.some(campo => !campo)) {
      alert('Por favor, complete todos los campos obligatorios');
      return;
    }

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Subir archivos si existen
      let imagenUrl = null;
      let documentoUrl = null;

      if (imagenResolucion) {
        imagenUrl = await subirArchivo(imagenResolucion, 'imagenes');
      }

      if (documentoResolucion) {
        documentoUrl = await subirArchivo(documentoResolucion, 'documentos');
      }

      // 2. Obtener estado anterior del proveedor
      const { data: casoActual } = await supabase
        .from("proveedor_casos")
        .select("estado_proveedor")
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true)
        .single();

      const estadoProveedorAnterior = casoActual?.estado_proveedor || null;

      // Obtener estado anterior del cliente
      const { data: incidenciaActual } = await supabase
        .from("incidencias")
        .select("estado_cliente")
        .eq("id", incidenciaId)
        .single();

      const estadoClienteAnterior = incidenciaActual?.estado_cliente || null;

      // 3. Cambiar ambos estados a "Resuelta"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Resuelta" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      await supabase
        .from("incidencias")
        .update({ estado_cliente: "Resuelta" })
        .eq("id", incidenciaId);

      // 4. Registrar cambios de estado en el historial
      const metadatosResolucion: any = {
        solucion_aplicada: solucionAplicada,
        tiene_oferta_aprobada: tieneOfertaAprobada,
        accion: 'resolver_incidencia'
      };

      if (!tieneOfertaAprobada && importeResolucion) {
        metadatosResolucion.importe_resolucion = parseFloat(importeResolucion);
      }

      if (notasResolucion) {
        metadatosResolucion.notas_adicionales = notasResolucion;
      }

      await registrarCambioEstado([
        {
          incidenciaId,
          tipoEstado: 'proveedor',
          estadoAnterior: estadoProveedorAnterior,
          estadoNuevo: 'Resuelta',
          autorId,
          motivo: 'Incidencia resuelta por proveedor',
          metadatos: metadatosResolucion
        },
        {
          incidenciaId,
          tipoEstado: 'cliente',
          estadoAnterior: estadoClienteAnterior,
          estadoNuevo: 'Resuelta',
          autorId,
          motivo: 'Incidencia resuelta por proveedor',
          metadatos: metadatosResolucion
        }
      ]);

      // 5. Crear comentario con información de resolución
      let mensajeSolucion = `Incidencia resuelta
Solución aplicada: ${solucionAplicada}`;

      if (!tieneOfertaAprobada && importeResolucion) {
        mensajeSolucion += `
Importe total sin IVA: ${importeResolucion}€`;
      }

      if (notasResolucion) {
        mensajeSolucion += `
Notas adicionales: ${notasResolucion}`;
      }

      const { data: comentarioCreado, error: comentarioError } = await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'ambos',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: 'Proveedor',
          cuerpo: mensajeSolucion,
          es_sistema: false
        })
        .select()
        .single();

      if (comentarioError) {
        console.error("Error creando comentario:", comentarioError);
        throw comentarioError;
      }

      // 6. Agregar adjuntos si existen
      const adjuntos = [];

      if (imagenUrl && comentarioCreado) {
        adjuntos.push({
          incidencia_id: incidenciaId,
          comentario_id: comentarioCreado.id,
          tipo: 'imagen',
          categoria: 'evidencia_resolucion',
          nombre_archivo: imagenResolucion?.name,
          storage_key: imagenUrl
        });
      }

      if (documentoUrl && comentarioCreado) {
        adjuntos.push({
          incidencia_id: incidenciaId,
          comentario_id: comentarioCreado.id,
          tipo: 'documento',
          categoria: 'documento_resolucion',
          nombre_archivo: documentoResolucion?.name,
          storage_key: documentoUrl
        });
      }

      if (adjuntos.length > 0) {
        const { error: adjuntosError } = await supabase
          .from("adjuntos")
          .insert(adjuntos);

        if (adjuntosError) {
          console.error("Error guardando adjuntos:", adjuntosError);
        }
      }

      // 7. Limpiar formulario y cerrar modal
      setMostrarModalResolver(false);
      setSolucionAplicada('');
      setImporteResolucion('');
      setImagenResolucion(null);
      setDocumentoResolucion(null);
      setNotasResolucion('');
      cargarDatos();

    } catch (error) {
      console.error("Error resolviendo incidencia:", error);
      alert('Error al resolver la incidencia. Por favor, inténtelo de nuevo.');
    } finally {
      setEnviando(false);
    }
  };

  const valorarIncidencia = async () => {
    if (!valoracion || !autorId) return;

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Cambiar estado_proveedor a "Valorada"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Valorada" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 2. Comentarios para ambos chats
      const mensajeValoracion = `Valoración del proveedor: ${valoracion}/5${comentariosValoracion ? `\nComentarios: ${comentariosValoracion}` : ''}`;

      await supabase
        .from("comentarios")
        .insert([
          {
            incidencia_id: incidenciaId,
            ambito: 'proveedor',
            autor_id: autorId,
            autor_email: userEmail,
            autor_rol: 'Proveedor',
            cuerpo: mensajeValoracion,
            es_sistema: true
          },
          {
            incidencia_id: incidenciaId,
            ambito: 'cliente',
            autor_id: autorId,
            autor_email: userEmail,
            autor_rol: 'Proveedor',
            cuerpo: `El proveedor ha completado la valoración de la incidencia:\n${mensajeValoracion}`,
            es_sistema: true
          }
        ]);

      setMostrarModalValorar(false);
      setValoracion('');
      setComentariosValoracion('');
      cargarDatos();

    } catch (error) {
      console.error("Error valorando incidencia:", error);
    } finally {
      setEnviando(false);
    }
  };

  // Funciones para acciones de Control
  const anularIncidencia = async () => {
    if (!motivoAnulacion.trim() || !autorId) return;

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Cambiar solo estado_proveedor a "Anulada"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Anulada" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 2. Comentario solo para el proveedor
      const mensajeAnulacion = `Asignación anulada por Control. Motivo: ${motivoAnulacion}`;

      await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'proveedor',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: 'Control',
          cuerpo: mensajeAnulacion,
          es_sistema: true
        });

      setMostrarModalAnular(false);
      setMotivoAnulacion('');
      cargarDatos();

    } catch (error) {
      console.error("Error anulando incidencia:", error);
    } finally {
      setEnviando(false);
    }
  };

  const cerrarIncidencia = async () => {
    if (!autorId) return;

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Cambiar estado_proveedor a "Cerrada"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Cerrada" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 2. Cambiar estado_cliente a "Cerrada"
      await supabase
        .from("incidencias")
        .update({ estado_cliente: "Cerrada" })
        .eq("id", incidenciaId);

      // 3. Comentarios para ambos chats
      const mensajeCierre = motivoCierre.trim()
        ? `Incidencia cerrada por Control. ${motivoCierre}`
        : 'Incidencia cerrada por Control.';

      await supabase
        .from("comentarios")
        .insert([
          {
            incidencia_id: incidenciaId,
            ambito: 'proveedor',
            autor_id: autorId,
            autor_email: userEmail,
            autor_rol: 'Control',
            cuerpo: mensajeCierre,
            es_sistema: true
          },
          {
            incidencia_id: incidenciaId,
            ambito: 'cliente',
            autor_id: autorId,
            autor_email: userEmail,
            autor_rol: 'Control',
            cuerpo: mensajeCierre,
            es_sistema: true
          }
        ]);

      setMostrarModalCerrar(false);
      setMotivoCierre('');
      cargarDatos();

    } catch (error) {
      console.error("Error cerrando incidencia:", error);
    } finally {
      setEnviando(false);
    }
  };

  const marcarPendienteValoracion = async () => {
    if (!autorId) return;

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Cambiar estado_proveedor a "Pendiente valoración"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Pendiente valoración" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 2. Comentario para el proveedor
      await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'proveedor',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: 'Control',
          cuerpo: 'La incidencia está lista para ser valorada por el proveedor.',
          es_sistema: true
        });

      setMostrarModalPendienteValoracion(false);
      cargarDatos();

    } catch (error) {
      console.error("Error marcando pendiente valoración:", error);
    } finally {
      setEnviando(false);
    }
  };

  // Función para cargar presupuesto
  const cargarPresupuesto = async () => {
    try {
      setCargandoPresupuesto(true);

      const { data: presupuestoData, error } = await supabase
        .from("presupuestos")
        .select("*")
        .eq("incidencia_id", incidenciaId)
        .order("creado_en", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error("Error cargando presupuesto:", error);
        return;
      }

      setPresupuestoActual(presupuestoData);
    } catch (error) {
      console.error("Error:", error);
    } finally {
      setCargandoPresupuesto(false);
    }
  };

  // Función para aprobar presupuesto
  const aprobarPresupuesto = async () => {
    if (!autorId || !presupuestoActual) return;

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Cambiar estado_proveedor a "Oferta aprobada"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Oferta aprobada" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 2. Actualizar estado del presupuesto
      await supabase
        .from("presupuestos")
        .update({ estado: "Aprobado" })
        .eq("id", presupuestoActual.id);

      // 3. Comentario para el proveedor
      await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'proveedor',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: 'Control',
          cuerpo: `Presupuesto aprobado por Control. Importe: ${presupuestoActual.importe_total_sin_iva}€ (sin IVA). Puedes proceder con la ejecución.`,
          es_sistema: true
        });

      setMostrarModalPresupuesto(false);
      cargarDatos();

    } catch (error) {
      console.error("Error aprobando presupuesto:", error);
    } finally {
      setEnviando(false);
    }
  };

  // Función para mandar a revisar presupuesto
  const mandarARevisar = async () => {
    if (!autorId || !presupuestoActual) return;

    try {
      setEnviando(true);

      const { data: userData } = await supabase.auth.getUser();
      const userEmail = userData.user?.email;

      // 1. Cambiar estado_proveedor a "Oferta a revisar"
      await supabase
        .from("proveedor_casos")
        .update({ estado_proveedor: "Oferta a revisar" })
        .eq("incidencia_id", incidenciaId)
        .eq("activo", true);

      // 2. Actualizar estado del presupuesto
      await supabase
        .from("presupuestos")
        .update({ estado: "A revisar" })
        .eq("id", presupuestoActual.id);

      // 3. Comentario para el proveedor
      await supabase
        .from("comentarios")
        .insert({
          incidencia_id: incidenciaId,
          ambito: 'proveedor',
          autor_id: autorId,
          autor_email: userEmail,
          autor_rol: 'Control',
          cuerpo: 'El presupuesto requiere revisión. Por favor, ajusta la oferta y reenvía.',
          es_sistema: true
        });

      setMostrarModalPresupuesto(false);
      cargarDatos();

    } catch (error) {
      console.error("Error mandando a revisar presupuesto:", error);
    } finally {
      setEnviando(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: PALETA.fondo }}>
        <div className="text-white">Cargando...</div>
      </div>
    );
  }

  if (!incidencia) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: PALETA.fondo }}>
        <div className="text-white">No se encontró la incidencia</div>
      </div>
    );
  }

  // Verificar si la incidencia ha sido asignada a un proveedor
  if (!loading && !proveedorAsignado) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center" style={{ backgroundColor: PALETA.fondo }}>
        <div className="text-center text-white max-w-md">
          <h2 className="text-xl font-semibold mb-4">Chat no disponible</h2>
          <p className="mb-6">
            Esta incidencia aún no ha sido asignada a ningún proveedor.
            El chat de proveedor estará disponible una vez que se realice la asignación.
          </p>
          <div className="flex gap-3 justify-center">
            <button
              onClick={() => router.push(`/control/incidencias?asignar=${incidenciaId}`)}
              className="px-4 py-2 text-white rounded hover:opacity-90 transition-colors"
              style={{ backgroundColor: PALETA.filtros }}
            >
              Asignar Proveedor
            </button>
            <button
              onClick={() => router.back()}
              className="px-4 py-2 bg-white text-gray-800 rounded hover:bg-gray-100 transition-colors"
            >
              ← Volver a incidencias
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Si la visita fue calendarizada exitosamente, mostrar pantalla de éxito
  if (visitaCalendarizada) {
    return (
      <div className="min-h-[calc(100vh-80px)] px-6 py-12" style={{ backgroundColor: PALETA.fondo }}>
        <div
          className="mx-auto w-full max-w-2xl rounded-lg p-8 shadow text-center"
          style={{ backgroundColor: PALETA.card }}
        >
          <div className="mb-6">
            <div
              className="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4"
              style={{ backgroundColor: PALETA.verdeClaro }}
            >
              <svg className="w-8 h-8" fill="none" stroke="#5D6D52" viewBox="0 0 24 24" strokeWidth={3}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h1 className="text-3xl font-semibold mb-2" style={{ color: PALETA.textoOscuro }}>
              ¡Visita calendarizada exitosamente!
            </h1>
            <p className="text-gray-600 mb-6">
              La visita ha sido programada correctamente en el sistema.
            </p>
          </div>

          <div className="bg-gray-50 rounded-lg p-6 mb-8">
            <h2 className="text-lg font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
              Detalles de la visita:
            </h2>
            <p className="text-2xl font-bold mb-2" style={{ color: PALETA.fondo }}>
              {visitaCalendarizada.fecha}
            </p>
            <p className="text-gray-600">
              {visitaCalendarizada.horario}
            </p>
            <p className="text-sm text-gray-500 mt-3">
              El estado se ha actualizado a "En resolución".
            </p>
          </div>

          <div className="space-y-3">
            <button
              onClick={() => setVisitaCalendarizada(null)}
              className="w-full rounded px-6 py-3 text-white font-medium"
              style={{ backgroundColor: PALETA.fondo }}
            >
              Continuar
            </button>
            <button
              onClick={() => router.push("/incidencias")}
              className="w-full rounded px-6 py-3 border border-gray-300 text-gray-700 font-medium hover:bg-gray-50"
            >
              Ver todas las incidencias
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen" style={{ backgroundColor: PALETA.fondo }}>
      {/* Header */}
      <div className="flex items-center justify-between p-6">
        <button
          onClick={() => router.back()}
          className="text-white text-sm hover:underline"
        >
          ← Volver a incidencias
        </button>

        <div></div>

        <div></div>
      </div>

      {/* Información de la incidencia - estilo mejorado */}
      <div className="px-6 pb-4">
        <div
          className="rounded-lg mb-6 shadow-lg border"
          style={{
            backgroundColor: PALETA.card,
            borderColor: PALETA.headerTable
          }}
        >
          <div
            className="px-6 py-4 mb-6 border-b"
            style={{
              backgroundColor: PALETA.headerTable,
              color: PALETA.textoOscuro
            }}
          >
            <h2 className="text-lg font-semibold">DATOS TÉCNICOS DE LA INCIDENCIA</h2>
          </div>
          
          {/* Determinar si hay imágenes para mostrar */}
          {(() => {
            const hasImages = incidencia.adjuntos_principales && incidencia.adjuntos_principales.length > 0 &&
              incidencia.adjuntos_principales.some(adjunto => imageUrls[adjunto.id]);

            return (
              <div className={`grid grid-cols-1 ${hasImages ? 'lg:grid-cols-3' : ''} gap-6 px-6 pb-6`}>
                {/* Tabla de datos técnicos */}
                <div className={hasImages ? "lg:col-span-2" : ""}>
                  <table className="w-full text-sm">
                    <tbody className="divide-y" style={{ borderColor: PALETA.headerTable }}>
                      <tr>
                        <td className="py-2 font-semibold w-1/3" style={{ color: PALETA.textoOscuro }}>
                          ID Solicitud:
                        </td>
                        <td className="py-2 font-mono" style={{ color: PALETA.textoOscuro }}>
                          {incidencia.num_solicitud}
                        </td>
                      </tr>

                      <tr style={{ backgroundColor: `${PALETA.headerTable}20` }}>
                        <td className="py-2 font-semibold" style={{ color: PALETA.textoOscuro }}>
                          Centro:
                        </td>
                        <td className="py-2" style={{ color: PALETA.textoOscuro }}>
                          {incidencia.instituciones?.[0]?.nombre || incidencia.centro || "-"}
                        </td>
                      </tr>

                      <tr>
                        <td className="py-2 font-semibold" style={{ color: PALETA.textoOscuro }}>
                          Fecha/Hora:
                        </td>
                        <td className="py-2 font-mono" style={{ color: PALETA.textoOscuro }}>
                          {incidencia.fecha && incidencia.hora
                            ? new Date(incidencia.fecha + 'T' + incidencia.hora).toLocaleString('es-ES', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                              })
                            : "-"
                          }
                        </td>
                      </tr>

                      <tr style={{ backgroundColor: `${PALETA.headerTable}20` }}>
                        <td className="py-2 font-semibold" style={{ color: PALETA.textoOscuro }}>
                          Estado:
                        </td>
                        <td className="py-2">
                          <span
                            className="px-2 py-1 rounded text-xs font-medium text-white"
                            style={{ backgroundColor: '#3b82f6' }}
                          >
                            {incidencia.estado_proveedor || incidencia.estado_cliente}
                          </span>
                        </td>
                      </tr>

                      <tr>
                        <td className="py-2 font-semibold" style={{ color: PALETA.textoOscuro }}>
                          Catalogación:
                        </td>
                        <td className="py-2" style={{ color: PALETA.textoOscuro }}>
                          {incidencia.catalogacion || "Sin catalogar"}
                        </td>
                      </tr>

                      <tr style={{ backgroundColor: `${PALETA.headerTable}20` }}>
                        <td className="py-2 font-semibold" style={{ color: PALETA.textoOscuro }}>
                          Prioridad:
                        </td>
                        <td className="py-2">
                          {incidencia.prioridad_proveedor ? (
                            <span
                              className="px-2 py-1 rounded text-xs font-medium text-white"
                              style={{
                                backgroundColor: incidencia.prioridad_proveedor === 'Crítico' ? '#ef4444' : '#10b981'
                              }}
                            >
                              {incidencia.prioridad_proveedor}
                            </span>
                          ) : (
                            <span style={{ color: PALETA.textoOscuro }}>No asignada</span>
                          )}
                        </td>
                      </tr>

                      <tr>
                        <td className="py-2 font-semibold align-top" style={{ color: PALETA.textoOscuro }}>
                          Descripción:
                        </td>
                        <td className="py-2 leading-relaxed" style={{ color: PALETA.textoOscuro }}>
                          {incidencia.descripcion_proveedor || incidencia.descripcion}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                {/* Sección de imágenes - solo mostrar si hay imágenes */}
                {hasImages && (
                  <div className="lg:col-span-1">
                    <div
                      className="border rounded-lg p-4"
                      style={{ borderColor: PALETA.headerTable }}
                    >
                      <h3 className="font-semibold mb-4 text-center" style={{ color: PALETA.textoOscuro }}>
                        EVIDENCIA VISUAL
                      </h3>

                      <div className="space-y-3">
                        {incidencia.adjuntos_principales.map((adjunto) => {
                          const imageUrl = imageUrls[adjunto.id];
                          if (!imageUrl) return null;
                          return (
                            <div key={adjunto.id} className="text-center">
                              <div
                                className="cursor-pointer border-2 rounded-lg overflow-hidden hover:shadow-lg transition-shadow"
                                style={{ borderColor: PALETA.fondo }}
                                onClick={() => window.open(imageUrl, '_blank')}
                              >
                                <img
                                  src={imageUrl}
                                  alt={adjunto.nombre_archivo || "Imagen de la incidencia"}
                                  className="w-full h-32 object-cover hover:scale-105 transition-transform duration-200"
                                  onError={(e) => {
                                    console.error('Error cargando imagen:', adjunto.storage_key);
                                    e.currentTarget.style.display = 'none';
                                  }}
                                />
                              </div>
                              <p className="text-xs mt-1 truncate" style={{ color: PALETA.textoOscuro }}>
                                {adjunto.nombre_archivo || "Imagen adjunta"}
                              </p>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })()}
        </div>
      </div>

      {/* Panel de acciones para Control */}
      {tipoUsuario === "Control" && (
        <div className="px-6 mb-6">
          <div className="bg-white rounded-lg shadow-sm p-4">
            <h3 className="font-semibold mb-4 text-center" style={{ color: PALETA.textoOscuro }}>
              ACCIONES DE CONTROL
            </h3>

            {(() => {
              const estado = incidencia.estado_proveedor;

              return (
                <div className="flex gap-3 justify-center flex-wrap">
                  {/* Botón Anular - siempre disponible si no está anulada o cerrada */}
                  {estado !== "Anulada" && estado !== "Cerrada" && (
                    <button
                      type="button"
                      onClick={() => setMostrarModalAnular(true)}
                      className="px-3 py-2 text-sm border border-red-500 text-red-600 bg-white rounded hover:bg-red-50 transition-colors"
                    >
                      Anular Proveedor
                    </button>
                  )}

                  {/* Botón Cerrar - disponible si está Resuelta o Valorada */}
                  {(estado === "Resuelta" || estado === "Valorada") && (
                    <button
                      type="button"
                      onClick={() => setMostrarModalCerrar(true)}
                      className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                      style={{ backgroundColor: "#059669" }}
                    >
                      Cerrar Incidencia
                    </button>
                  )}

                  {/* Botón Gestionar Presupuesto - solo si está Ofertada */}
                  {estado === "Ofertada" && (
                    <button
                      type="button"
                      onClick={() => {
                        cargarPresupuesto();
                        setMostrarModalPresupuesto(true);
                      }}
                      className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                      style={{ backgroundColor: "#0ea5e9" }}
                    >
                      Gestionar Presupuesto
                    </button>
                  )}

                  {/* Botón Pendiente Valoración - solo si está Resuelta */}
                  {estado === "Resuelta" && (
                    <button
                      type="button"
                      onClick={() => setMostrarModalPendienteValoracion(true)}
                      className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                      style={{ backgroundColor: "#7c3aed" }}
                    >
                      Pendiente Valoración
                    </button>
                  )}
                </div>
              );
            })()}
          </div>
        </div>
      )}

      {/* Botones de acciones del proveedor */}
      {tipoUsuario === 'Proveedor' && (
        <div className="px-6 mb-6">
          <div className="bg-white rounded-lg shadow-sm p-4">
            <h3 className="font-semibold mb-4 text-center" style={{ color: PALETA.textoOscuro }}>
              ACCIONES DISPONIBLES
            </h3>

            {/* Lógica de botones basada en estado */}
            {(() => {
              const estado = incidencia.estado_proveedor;

              // Definir disponibilidad de botones según estado
              const botonesDisponibles = {
                calendarizar: false,
                ofertar: false,
                resolver: false,
                valorar: false
              };

              // Mensajes informativos por estado
              let mensaje = '';

              switch (estado) {
                case "Abierta":
                case "En resolución":
                  botonesDisponibles.calendarizar = true;
                  botonesDisponibles.ofertar = true;
                  botonesDisponibles.resolver = true;
                  break;

                case "Ofertada":
                  mensaje = '⏳ Esperando respuesta de Control sobre la oferta enviada';
                  break;

                case "Oferta aprobada":
                  botonesDisponibles.calendarizar = true;
                  botonesDisponibles.resolver = true;
                  break;

                case "Oferta a revisar":
                  botonesDisponibles.calendarizar = true;
                  botonesDisponibles.ofertar = true;
                  botonesDisponibles.resolver = true;
                  break;

                case "Resuelta":
                  mensaje = '✅ Incidencia resuelta - Esperando confirmación de Control';
                  break;

                case "Pendiente valoración":
                  botonesDisponibles.valorar = true;
                  mensaje = '📋 Incidencia lista para valorar';
                  break;

                case "Valorada":
                case "Cerrada":
                case "Anulada":
                  mensaje = '🔒 Incidencia finalizada - No hay acciones disponibles';
                  break;

                default:
                  // Estados no contemplados - habilitar botones básicos
                  botonesDisponibles.calendarizar = true;
                  botonesDisponibles.ofertar = true;
                  botonesDisponibles.resolver = true;
              }

              return (
                <>
                  {/* Mostrar mensaje si existe */}
                  {mensaje && (
                    <div className="text-center py-4">
                      <p className="text-sm text-gray-600 mb-2">{mensaje}</p>
                      {!botonesDisponibles.valorar && mensaje.includes('Esperando') && (
                        <p className="text-xs text-gray-500">
                          Las acciones estarán disponibles cuando Control responda.
                        </p>
                      )}
                    </div>
                  )}

                  {/* Botones principales */}
                  {(botonesDisponibles.calendarizar || botonesDisponibles.ofertar || botonesDisponibles.resolver) && (
                    <div className="flex gap-3 justify-center flex-wrap">
                      {botonesDisponibles.calendarizar && (
                        <button
                          type="button"
                          onClick={() => setMostrarModalVisita(true)}
                          className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                          style={{ backgroundColor: PALETA.verdeClaro }}
                        >
                          Calendarizar Visita
                        </button>
                      )}

                      {botonesDisponibles.ofertar && (
                        <button
                          type="button"
                          onClick={() => setMostrarModalPresupuesto(true)}
                          className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                          style={{ backgroundColor: PALETA.verdeClaro }}
                        >
                          Ofertar Presupuesto
                        </button>
                      )}

                      {botonesDisponibles.resolver && (
                        <button
                          type="button"
                          onClick={() => setMostrarModalResolver(true)}
                          className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                          style={{ backgroundColor: PALETA.verdeClaro }}
                        >
                          Resolver Incidencia
                        </button>
                      )}
                    </div>
                  )}

                  {/* Botón de valorar */}
                  {botonesDisponibles.valorar && (
                    <div className="flex justify-center mt-4">
                      <button
                        type="button"
                        onClick={() => setMostrarModalValorar(true)}
                        className="px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
                        style={{ backgroundColor: PALETA.verdeClaro }}
                      >
                        Valorar Incidencia
                      </button>
                    </div>
                  )}
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* Título del chat */}
      <div className="px-6 mb-8">
        {tipoUsuario === 'Control' ? (
          <div className="text-white text-center">
            <h2 className="text-lg font-semibold mb-1 tracking-wider">CHAT PROVEEDOR</h2>
            <p className="text-sm opacity-80">#{incidencia.num_solicitud}</p>
            {nombreProveedor && (
              <p className="text-sm opacity-90 mt-1" style={{ color: PALETA.headerTable }}>
                {nombreProveedor}
              </p>
            )}
          </div>
        ) : (
          <h2 className="text-white text-center text-lg font-semibold mb-4 tracking-wider">SEGUIMIENTO</h2>
        )}
      </div>

      {/* Chat */}
      <div className="px-6 pb-6">
        <div className="bg-white rounded-lg shadow-sm flex flex-col h-[500px]">
          {/* Comentarios */}
          <div className="flex-1 p-4 overflow-y-auto space-y-3">
            {comentarios.length === 0 ? (
              <div className="text-center text-gray-500 py-8">
                No hay comentarios aún. ¡Sé el primero en escribir!
              </div>
            ) : (
              comentarios.map((comentario) => (
                <div
                  key={comentario.id}
                  className={`flex ${
                    comentario.es_sistema 
                      ? 'justify-center' 
                      : comentario.autor_rol === tipoUsuario ? 'justify-end' : 'justify-start'
                  }`}
                >
                  <div
                    className="max-w-xs md:max-w-md rounded-lg p-3"
                    style={{
                      backgroundColor: comentario.es_sistema 
                        ? '#fef3c7'
                        : comentario.autor_rol === tipoUsuario 
                          ? getColorEmisor(comentario.autor_rol || 'proveedor')
                          : "#f3f4f6"
                    }}
                  >
                    {!comentario.es_sistema && (
                      <div className="text-xs font-medium mb-1" style={{ 
                        color: PALETA.fondo 
                      }}>
                        {`${comentario.autor_email} (${comentario.autor_rol})`}
                      </div>
                    )}
                    <div className="text-sm whitespace-pre-line">{comentario.cuerpo}</div>
                    
                    {/* Mostrar adjuntos */}
                    {comentario.adjuntos && comentario.adjuntos.length > 0 && (
                      <div className="mt-2 space-y-2">
                        {comentario.adjuntos.map((adjunto) => (
                          <div key={adjunto.id}>
                            {adjunto.tipo === 'imagen' && (
                              (() => {
                                const imageUrl = commentAttachmentUrls[adjunto.id];
                                return imageUrl ? (
                                  <img 
                                    src={imageUrl} 
                                    alt={adjunto.nombre_archivo || "Imagen adjunta"}
                                    className="max-w-sm rounded border cursor-pointer"
                                    onClick={() => window.open(imageUrl, '_blank')}
                                  />
                                ) : null;
                              })()
                            )}
                            {adjunto.tipo === 'documento' && (
                              (() => {
                                const documentUrl = commentAttachmentUrls[adjunto.id] || adjunto.storage_key;
                                return documentUrl ? (
                                  <a 
                                    href={documentUrl} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="inline-flex items-center gap-2 text-blue-600 hover:underline text-sm bg-blue-50 px-3 py-1 rounded"
                                  >
                                    📎 {adjunto.nombre_archivo || 'Documento adjunto'}
                                  </a>
                                ) : null;
                              })()
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                    
                    <div className="text-xs opacity-75 mt-1">
                      {new Date(comentario.creado_en).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>

          {/* Formulario de envío */}
          <form onSubmit={enviarComentario} className="border-t p-4 space-y-4">
            <textarea
              value={nuevoComentario}
              onChange={(e) => setNuevoComentario(e.target.value)}
              placeholder="Escribe tu comentario..."
              className="w-full h-20 p-3 border rounded focus:outline-none resize-none text-sm"
              style={{ borderColor: PALETA.textoOscuro }}
              disabled={enviando}
            />
            
            {/* Preview de archivos seleccionados */}
            {(imagenSeleccionada || documentoSeleccionado) && (
              <div className="flex gap-2 flex-wrap">
                {imagenSeleccionada && (
                  <div className="flex items-center gap-2 bg-white px-3 py-2 rounded border border-gray-300">
                    <span className="text-gray-700 text-sm">{imagenSeleccionada.name}</span>
                    <button
                      type="button"
                      onClick={() => setImagenSeleccionada(null)}
                      className="text-gray-500 hover:text-gray-700 text-sm"
                      style={{
                        color: PALETA.textoOscuro,
                        transition: 'color 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.color = PALETA.fondo;
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.color = PALETA.textoOscuro;
                      }}
                    >
                      ×
                    </button>
                  </div>
                )}
                {documentoSeleccionado && (
                  <div className="flex items-center gap-2 bg-white px-3 py-2 rounded border border-gray-300">
                    <span className="text-gray-700 text-sm">{documentoSeleccionado.name}</span>
                    <button
                      type="button"
                      onClick={() => setDocumentoSeleccionado(null)}
                      className="text-gray-500 hover:text-gray-700 text-sm"
                      style={{
                        color: PALETA.textoOscuro,
                        transition: 'color 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.color = PALETA.fondo;
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.color = PALETA.textoOscuro;
                      }}
                    >
                      ×
                    </button>
                  </div>
                )}
              </div>
            )}

            {/* Botones de archivos adjuntos */}
            <div className="flex gap-4 items-center">
              <div className="relative">
                <input
                  type="file"
                  id="imagen"
                  accept="image/*"
                  onChange={manejarSeleccionImagen}
                  className="hidden"
                />
                <label
                  htmlFor="imagen"
                  className="inline-flex items-center gap-2 px-3 py-0.5 border border-gray-400 rounded cursor-pointer transition-colors text-gray-600"
                  style={{
                    borderColor: PALETA.textoOscuro
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = PALETA.headerTable;
                    e.currentTarget.style.color = PALETA.textoOscuro;
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '';
                    e.currentTarget.style.color = '#4b5563';
                  }}
                >
                  <span className="font-medium text-sm">Añadir imagen</span>
                  <span className="text-2xl text-gray-400">+</span>
                </label>
              </div>
              
              <div className="relative">
                <input
                  type="file"
                  id="documento"
                  accept=".pdf,.doc,.docx,.txt"
                  onChange={manejarSeleccionDocumento}
                  className="hidden"
                />
                <label
                  htmlFor="documento"
                  className="inline-flex items-center gap-2 px-3 py-0.5 border border-gray-400 rounded cursor-pointer transition-colors text-gray-600"
                  style={{
                    borderColor: PALETA.textoOscuro
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = PALETA.headerTable;
                    e.currentTarget.style.color = PALETA.textoOscuro;
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '';
                    e.currentTarget.style.color = '#4b5563';
                  }}
                >
                  <span className="font-medium text-sm">Añadir documento</span>
                  <span className="text-2xl text-gray-400">+</span>
                </label>
              </div>

              <button
                type="submit"
                disabled={!nuevoComentario.trim() || enviando}
                className="px-4 py-2 text-white rounded disabled:opacity-50 hover:opacity-90 transition-opacity ml-auto"
                style={{ backgroundColor: PALETA.fondo }}
              >
                {enviando ? "Enviando..." : "Enviar"}
              </button>
            </div>
          </form>
        </div>
      </div>

      {/* Modal para calendarizar visita */}
      {mostrarModalVisita && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-8 max-w-md w-full mx-4 shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Calendarizar Visita
            </h3>

            <div className="space-y-6">
              {/* Fecha */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Fecha de la visita *
                </label>
                <input
                  type="date"
                  value={fechaVisita}
                  onChange={(e) => setFechaVisita(e.target.value)}
                  min={new Date().toISOString().split('T')[0]}
                  className="w-full h-9 rounded border px-3 text-sm outline-none"
                  style={{
                    '--focus-border-color': PALETA.verdeClaro,
                  } as any}
                  onFocus={(e) => {
                    e.target.style.borderColor = PALETA.verdeClaro;
                    e.target.style.boxShadow = `0 0 0 2px ${PALETA.verdeClaro}40`;
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '';
                    e.target.style.boxShadow = '';
                  }}
                  required
                />
              </div>

              {/* Horario */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Horario *
                </label>
                <select
                  value={horarioVisita}
                  onChange={(e) => setHorarioVisita(e.target.value)}
                  className="w-full h-9 rounded border px-3 text-sm outline-none bg-white"
                  style={{
                    '--focus-border-color': PALETA.verdeClaro,
                  } as any}
                  onFocus={(e) => {
                    e.target.style.borderColor = PALETA.verdeClaro;
                    e.target.style.boxShadow = `0 0 0 2px ${PALETA.verdeClaro}40`;
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '';
                    e.target.style.boxShadow = '';
                  }}
                  required
                >
                  <option value="">Seleccione un horario</option>
                  <option value="mañana">Horario de mañana</option>
                  <option value="tarde">Horario de tarde</option>
                </select>
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-8">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalVisita(false);
                  setFechaVisita('');
                  setHorarioVisita('');
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={calendarizarVisita}
                disabled={!fechaVisita || !horarioVisita || enviando}
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: '#7A8A6F' }}
              >
                {enviando ? 'Calendarizando...' : 'Calendarizar Visita'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para ofertar presupuesto */}
      {mostrarModalPresupuesto && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div
            className="rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Datos presupuesto
            </h3>

            <div className="space-y-6">
              {/* Número de incidencia */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  N° incidencia
                </label>
                <input
                  type="text"
                  value={incidencia?.num_solicitud || ''}
                  disabled
                  className="w-full h-9 rounded border px-3 text-sm bg-gray-100"
                />
              </div>

              {/* Fecha estimada de inicio y Duración estimada */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                    Fecha estimada de inicio *
                  </label>
                  <input
                    type="date"
                    value={fechaEstimadaInicio}
                    onChange={(e) => setFechaEstimadaInicio(e.target.value)}
                    className="w-full h-9 rounded border px-3 text-sm outline-none"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                    Duración estimada *
                  </label>
                  <input
                    type="text"
                    value={duracionEstimada}
                    onChange={(e) => setDuracionEstimada(e.target.value)}
                    className="w-full h-9 rounded border px-3 text-sm outline-none"
                    placeholder="ej: 2 días, 1 semana..."
                    required
                  />
                </div>
              </div>

              {/* Importe total sin IVA y Presupuesto detallado */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                    Importe total sin IVA (€) *
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={importeTotalSinIva}
                    onChange={(e) => setImporteTotalSinIva(e.target.value)}
                    className="w-full h-9 rounded border px-3 text-sm outline-none"
                    placeholder="0.00"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                    Presupuesto detallado *
                  </label>
                  <div className="relative">
                    <input
                      type="file"
                      onChange={(e) => setDocumentoPresupuesto(e.target.files?.[0] || null)}
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                      accept=".pdf,.doc,.docx,.xls,.xlsx"
                      required
                    />
                    <div className="w-full h-9 rounded border px-3 text-sm bg-white flex items-center justify-center cursor-pointer hover:bg-gray-50">
                      <span className="text-3xl">+</span>
                    </div>
                  </div>
                  {documentoPresupuesto && (
                    <p className="text-xs text-gray-600 mt-1">{documentoPresupuesto.name}</p>
                  )}
                </div>
              </div>

              {/* Descripción breve */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Descripción breve *
                </label>
                <textarea
                  value={descripcionPresupuesto}
                  onChange={(e) => setDescripcionPresupuesto(e.target.value)}
                  className="w-full h-24 rounded border px-3 py-2 text-sm outline-none resize-none"
                  placeholder="Descripción breve del trabajo a realizar..."
                  required
                />
              </div>
            </div>


            <div className="flex justify-end gap-3 mt-8">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalPresupuesto(false);
                  setFechaEstimadaInicio('');
                  setDuracionEstimada('');
                  setImporteTotalSinIva('');
                  setDocumentoPresupuesto(null);
                  setDescripcionPresupuesto('');
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={ofertarPresupuesto}
                disabled={!fechaEstimadaInicio || !duracionEstimada || !importeTotalSinIva || !documentoPresupuesto || !descripcionPresupuesto || enviando}
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: '#7A8A6F' }}
              >
                {enviando ? 'Enviando...' : 'Enviar a revisión'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para resolver incidencia */}
      {mostrarModalResolver && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div
            className="rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Resolver Incidencia
              {tieneOfertaAprobada && (
                <span className="text-sm text-green-600 block mt-1">
                  ✓ Incidencia con oferta aprobada
                </span>
              )}
            </h3>

            <div className="space-y-6">
              {/* Solución aplicada - Siempre obligatorio */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Solución aplicada *
                </label>
                <textarea
                  value={solucionAplicada}
                  onChange={(e) => setSolucionAplicada(e.target.value)}
                  className="w-full h-24 rounded border px-3 py-2 text-sm outline-none resize-none"
                  placeholder="Describe la solución aplicada..."
                  required
                />
              </div>

              {/* Importe - Solo obligatorio si NO tiene oferta aprobada */}
              {!tieneOfertaAprobada && (
                <div>
                  <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                    Importe total sin IVA (€) *
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={importeResolucion}
                    onChange={(e) => setImporteResolucion(e.target.value)}
                    className="w-full h-9 rounded border px-3 text-sm outline-none"
                    placeholder="0.00"
                    required
                  />
                  <p className="text-xs text-gray-600 mt-1">
                    Este campo es obligatorio para incidencias sin oferta previa
                  </p>
                </div>
              )}

              {/* Imagen de evidencia - Opcional */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Imagen de evidencia (opcional)
                </label>
                <div className="relative">
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => setImagenResolucion(e.target.files?.[0] || null)}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  />
                  <div className="w-full h-9 rounded border px-3 text-sm bg-white flex items-center justify-center cursor-pointer hover:bg-gray-50">
                    <span className="text-3xl">+</span>
                  </div>
                </div>
                {imagenResolucion && (
                  <p className="text-xs text-gray-600 mt-1">{imagenResolucion.name}</p>
                )}
              </div>

              {/* Documento justificativo - Opcional */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Documento justificativo (opcional)
                </label>
                <div className="relative">
                  <input
                    type="file"
                    accept=".pdf,.doc,.docx,.xls,.xlsx"
                    onChange={(e) => setDocumentoResolucion(e.target.files?.[0] || null)}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  />
                  <div className="w-full h-9 rounded border px-3 text-sm bg-white flex items-center justify-center cursor-pointer hover:bg-gray-50">
                    <span className="text-3xl">+</span>
                  </div>
                </div>
                {documentoResolucion && (
                  <p className="text-xs text-gray-600 mt-1">{documentoResolucion.name}</p>
                )}
              </div>

              {/* Notas adicionales - Opcional */}
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Notas adicionales (opcional)
                </label>
                <textarea
                  value={notasResolucion}
                  onChange={(e) => setNotasResolucion(e.target.value)}
                  className="w-full h-20 rounded border px-3 py-2 text-sm outline-none resize-none"
                  placeholder="Comentarios adicionales sobre la resolución..."
                />
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-8">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalResolver(false);
                  setSolucionAplicada('');
                  setImporteResolucion('');
                  setImagenResolucion(null);
                  setDocumentoResolucion(null);
                  setNotasResolucion('');
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={resolverIncidencia}
                disabled={
                  !solucionAplicada ||
                  (!tieneOfertaAprobada && !importeResolucion) ||
                  enviando
                }
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: '#7A8A6F' }}
              >
                {enviando ? 'Resolviendo...' : 'Marcar como Resuelta'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para valorar incidencia */}
      {mostrarModalValorar && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-8 max-w-md w-full mx-4 shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Valorar Incidencia
            </h3>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Valoración *
                </label>
                <select
                  value={valoracion}
                  onChange={(e) => setValoracion(e.target.value)}
                  className="w-full h-9 rounded border px-3 text-sm outline-none "
                  required
                >
                  <option value="">Selecciona valoración</option>
                  <option value="1">⭐ 1 - Muy insatisfecho</option>
                  <option value="2">⭐⭐ 2 - Insatisfecho</option>
                  <option value="3">⭐⭐⭐ 3 - Neutral</option>
                  <option value="4">⭐⭐⭐⭐ 4 - Satisfecho</option>
                  <option value="5">⭐⭐⭐⭐⭐ 5 - Muy satisfecho</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Comentarios adicionales
                </label>
                <textarea
                  value={comentariosValoracion}
                  onChange={(e) => setComentariosValoracion(e.target.value)}
                  className="w-full h-20 rounded border px-3 py-2 text-sm outline-none  resize-none"
                  placeholder="Comentarios sobre la resolución de la incidencia..."
                />
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-6">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalValorar(false);
                  setValoracion('');
                  setComentariosValoracion('');
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={valorarIncidencia}
                disabled={!valoracion || enviando}
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: '#7A8A6F' }}
              >
                {enviando ? 'Valorando...' : 'Enviar Valoración'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para anular incidencia */}
      {mostrarModalAnular && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-8 max-w-md w-full mx-4 shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Anular Asignación de Proveedor
            </h3>

            <div className="space-y-4">
              <p className="text-sm text-gray-600">
                Esta acción anulará la asignación del proveedor actual. Posteriormente podrás asignar otro proveedor. Por favor, proporciona el motivo:
              </p>

              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Motivo de anulación *
                </label>
                <textarea
                  value={motivoAnulacion}
                  onChange={(e) => setMotivoAnulacion(e.target.value)}
                  className="w-full h-20 rounded border px-3 py-2 text-sm outline-none resize-none"
                  placeholder=""
                  required
                />
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-6">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalAnular(false);
                  setMotivoAnulacion('');
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={anularIncidencia}
                disabled={!motivoAnulacion.trim() || enviando}
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: PALETA.fondo }}
              >
                {enviando ? 'Anulando...' : 'Anular Proveedor'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para cerrar incidencia */}
      {mostrarModalCerrar && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-8 max-w-md w-full mx-4 shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Cerrar Incidencia
            </h3>

            <div className="space-y-4">
              <p className="text-sm text-gray-600">
                La incidencia será marcada como cerrada. Los comentarios adicionales son opcionales:
              </p>

              <div>
                <label className="block text-sm font-medium mb-2" style={{ color: PALETA.textoOscuro }}>
                  Comentarios (opcional)
                </label>
                <textarea
                  value={motivoCierre}
                  onChange={(e) => setMotivoCierre(e.target.value)}
                  className="w-full h-20 rounded border px-3 py-2 text-sm outline-none resize-none"
                  placeholder="Comentarios sobre el cierre de la incidencia..."
                />
              </div>
            </div>

            <div className="flex justify-end gap-3 mt-6">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalCerrar(false);
                  setMotivoCierre('');
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={cerrarIncidencia}
                disabled={enviando}
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: '#059669' }}
              >
                {enviando ? 'Cerrando...' : 'Cerrar Incidencia'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para pendiente valoración */}
      {mostrarModalPendienteValoracion && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-8 max-w-md w-full mx-4 shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Marcar Pendiente de Valoración
            </h3>

            <div className="space-y-4">
              <p className="text-sm text-gray-600">
                La incidencia será marcada como "Pendiente valoración" para que el proveedor pueda valorarla.
              </p>
            </div>

            <div className="flex justify-end gap-3 mt-6">
              <button
                type="button"
                onClick={() => setMostrarModalPendienteValoracion(false)}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={marcarPendienteValoracion}
                disabled={enviando}
                className="px-6 py-2 text-sm text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                style={{ backgroundColor: '#7c3aed' }}
              >
                {enviando ? 'Marcando...' : 'Marcar Pendiente Valoración'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal para gestionar presupuesto */}
      {mostrarModalPresupuesto && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div
            className="rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow"
            style={{ backgroundColor: PALETA.card }}
          >
            <h3 className="text-xl font-semibold mb-6" style={{ color: PALETA.textoOscuro }}>
              Gestionar Presupuesto
            </h3>

            {cargandoPresupuesto ? (
              <div className="text-center py-8">
                <p className="text-gray-600">Cargando presupuesto...</p>
              </div>
            ) : !presupuestoActual ? (
              <div className="text-center py-8">
                <p className="text-red-600">No se encontró el presupuesto para esta incidencia.</p>
              </div>
            ) : (
              <div className="space-y-6">
                {/* Información del presupuesto */}
                <div className="bg-gray-50 p-4 rounded-lg">
                  <h4 className="font-semibold mb-3" style={{ color: PALETA.textoOscuro }}>
                    Detalles del Presupuesto
                  </h4>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="font-medium">Descripción:</span>
                      <p className="mt-1">{presupuestoActual.descripcion || 'No especificada'}</p>
                    </div>

                    <div>
                      <span className="font-medium">Importe (sin IVA):</span>
                      <p className="mt-1 text-lg font-bold text-green-600">
                        {presupuestoActual.importe_total_sin_iva}€
                      </p>
                    </div>

                    <div>
                      <span className="font-medium">Fecha estimada de inicio:</span>
                      <p className="mt-1">{presupuestoActual.fecha_estimada_inicio || 'No especificada'}</p>
                    </div>

                    <div>
                      <span className="font-medium">Duración estimada:</span>
                      <p className="mt-1">{presupuestoActual.duracion_estimada || 'No especificada'}</p>
                    </div>
                  </div>

                  {presupuestoActual.presupuesto_detallado_url && (
                    <div className="mt-4">
                      <span className="font-medium">Documento detallado:</span>
                      <div className="mt-2">
                        <a
                          href={presupuestoActual.presupuesto_detallado_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 underline"
                        >
                          📄 Ver presupuesto detallado
                        </a>
                      </div>
                    </div>
                  )}
                </div>

                {/* Opciones de gestión */}
                <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                  <h4 className="font-semibold mb-2 text-yellow-800">
                    ¿Qué deseas hacer con este presupuesto?
                  </h4>
                  <p className="text-sm text-yellow-700 mb-4">
                    Selecciona una opción para continuar con el proceso:
                  </p>

                  <div className="flex gap-3 flex-wrap">
                    <button
                      type="button"
                      onClick={aprobarPresupuesto}
                      disabled={enviando}
                      className="px-6 py-2 text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                      style={{ backgroundColor: '#059669' }}
                    >
                      {enviando ? 'Aprobando...' : '✅ Aprobar Presupuesto'}
                    </button>

                    <button
                      type="button"
                      onClick={mandarARevisar}
                      disabled={enviando}
                      className="px-6 py-2 text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50"
                      style={{ backgroundColor: '#f59e0b' }}
                    >
                      {enviando ? 'Enviando...' : '📝 Mandar a Revisar'}
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="flex justify-end gap-3 mt-6">
              <button
                type="button"
                onClick={() => {
                  setMostrarModalPresupuesto(false);
                  setPresupuestoActual(null);
                }}
                className="px-4 py-2 text-sm rounded border hover:bg-gray-50 transition-colors"
                style={{ color: PALETA.textoOscuro, borderColor: '#d1d5db' }}
                disabled={enviando}
              >
                Cerrar
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}